---
onin
title: "Entrenamiento de coeficientes"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(metR)
library(data.table)
library(lubridate)
library(scattermore)
library(patchwork)
source("help_functions.R")
source("postprocesamiento.R")
source("goes_functions.R")

map <- rnaturalearth::ne_states(country = c("argentina", "Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")

geom_mapa <- function() {
  geom_sf(data = map, fill = NA, color = "black", size = 0.2, inherit.aes = FALSE)
}

coord <- ReadNetCDF("analisis/q_20181121210000_E3.nc", vars = c(lon = "XLONG")) %>%
  .[, lat := ReadNetCDF("analisis/q_20181121210000_E3.nc", vars = c(lat = "XLAT"))$lat]
```

## Primera semana de entrenamiento

```{r}
files <- list.files("/home/paola.corrales/datosmunin/EXP/E7/ANA/training/",
                    pattern = "satbias_2", 
                    recursive = TRUE,
                    full.names = TRUE)

satbias <- map(files, function(f){
  meta <- unglue::unglue(basename(f), "satbias_{date}")
  read_satbias(f) %>% 
    as.data.table() %>% 
    .[, ":="(date = ymd_hms(meta[[1]][["date"]]))]
  
}) %>% 
  rbindlist()

sensores <- c("amsua_n15",
              "amsua_n18",
              "amsua_n19",
              # "amsua_metop_a",
              "amsua_metop-b",
              "amsua_aqua",
              "airs_aqua",
              "iasi_metop-a",
              "iasi_metop-b", 
              "hirs4_n19",
              "hirs4_metop-a",
              "hirs4_metop-b",
              "mhs_metop-a",
              "mhs_metop-b",
              "mhs_n18",
              "mhs_n19",
              "mhs_metop-a",
              "atms_npp",
              "atms_n20",
              "cris-fsr_npp",
              "cris-fsr_n20"
)

satbias <- satbias[sensor %in% sensores]

satinfo <- fread("satinfo.txt") %>% 
  setnames(c("!sensor/instr/sat", "chan"), c("sensor", "channel"))

satbias <- satinfo[satbias, on = c("sensor", "channel")]
```

```{r}
# satbias[sensor %in% sensores[1] & iuse == 1] %>% 
#   melt(measure.vars = paste0("coeff", c(1, 3:5, 8))) %>% 
#   ggplot(aes(date, value)) +
#   geom_point(aes(group = channel), size= 0.5) +
#   geom_path(aes(group = channel), size= 0.5) +
#   scale_x_datetime(date_labels = "%d") +
#   labs(title = paste("Coefficientes for", sensores[1]),
#        subtitle = "Channel 4") +
#   facet_grid(channel~variable, scales = "free_y", 
#              labeller = labeller(variable = c("coeff1" = "Offset",
#                                               "coeff3" = "CLW",
#                                               "coeff4" = "TLR^2",
#                                               "coeff5" = "TLR",
#                                               "coeff8" = "Emiss"))) +
#   theme_minimal() 


for (this_sensor in sensores){
  print(this_sensor)
  g <- satbias[sensor %in% this_sensor & iuse == 1] %>% 
    melt(measure.vars = paste0("coeff", c(1, 3:5, 8))) %>% 
    ggplot(aes(date, value)) +
    geom_point(aes(color = variable), size= 0.5) +
    geom_path(aes(color = variable), size= 0.5) +
    scale_color_brewer(type = "qual", palette = "Dark2",
                       labels = c("coeff1" = "Offset",
                                  "coeff3" = "CLW",
                                  "coeff4" = "TLR^2",
                                  "coeff5" = "TLR",
                                  "coeff8" = "Emiss")) +
    scale_x_datetime(date_labels = "%d") +
    labs(title = paste("Coefficientes for", this_sensor),
         color = "") +
    facet_wrap(~channel, scales = "free_y", ncol = 5) +
    theme_minimal() +
    theme(legend.position = "bottom")
  
   rows <- satbias[sensor %in% this_sensor & iuse == 1, channel] %>% 
    unique(by = channel) %>% 
    length() / 5
  
  h <- ceiling(ceiling(rows)*700/300)
  if (h > 0){
  
  ggsave(paste0(this_sensor, ".png"), plot = g, width = 9, height = h, limitsize = FALSE)
}
}


  
 
```

```{r}
satinfo[iuse == 1, .N, by = .(sensor)]
```

