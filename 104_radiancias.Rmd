---
title: "104_radiancias"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(metR)
library(data.table)
library(lubridate)
library(scattermore)
source("help_functions.R")
source("postprocesamiento.R")
source("goes_functions.R")

map <- rnaturalearth::ne_states(country = c("argentina", "Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")

geom_mapa <- function() {
  geom_sf(data = map, fill = NA, color = "black", size = 0.2, inherit.aes = FALSE)
}
```

## GOES 16

Canales en la región del infrarrojo

| Canal | Longitud de onda Central $\mu m$ | Observaciones | Función de peso |
|:-----:|:----------:|:------------------------------------|:----------------------------|
|  7  |  3.9  | Sensible tanto a la radiación del sol como a la emitida por la Tierra | Maxímo en superficie |
|  8  |  6.2  | Sensible al vapor de agua | Máximo en 425 hPa. |
|  9  |  6.9  | Predomina la absorción por vapor de agua | Maxímo cercano a 460 hPa. |
| 10  |  7.3  | Sensible al vapor de agua | Máximo en 640 hPa. |
| 11  |  8.4  | Para estudio de microfísica de nubes y plumas volcánicas con ceniza y dióxido de sulfuro | Máximo en niveles bajos |
| 12  |  9.6  | Absorción por ozono  | Máximo en la estratósfera |
| 13  | 10.3  | Ventana radiativa, absorción despresiable en la atmósfera. Cerca del $\lambda$ de máxima emisión terrestre | Máximo en superficie |
| 14  | 11.2  | Ventana radiativa con mayor absorción de vapor de agua | |
| 15  | 12.3  | Ventana radiativa con mayor absorción de vapor de agua | |
| 16  | 13.3  | Absorción por dióxido de carbono | Máximo cerca de superficie |


Al parecer las observaciones de GOES vienen en archivos .nc, uno por canal en radiancias. 


```{r echo=FALSE, fig.height=4, dpi=150}
files <- list.files(path = "/home/paola.corrales/datosmunin/DA/DA_DATA/GOES16/", pattern = "nc", full.names = TRUE)

#dominio de interés
xlim <- c(2600, 3950)
ylim <- c(3700, 4750)

tb_goes <- purrr::map(files, function(f) {
  
  meta <- unglue::unglue(basename(f), "OR_ABI-L1b-RadF-M3{channel}_G16_s{sdate}_e{edate}_c{cdate}.nc")
  nc <- ncdf4::nc_open(f)
  # mu <- ncvar_get(nc, "band_wavelength")*1e-6
  out <- ReadNetCDF(f, vars = c(rad = "Rad", qf = "DQF"), 
                    subset = list(x = xlim, y = ylim)) %>% 
    .[, rad := calculate_rad(rad, nc)] %>% 
    .[, tb := rad_to_tb(rad, nc)] %>% 
    .[, channel := meta[[1]][["channel"]]] %>% 
    .[, c("lon", "lat") := goes_projection(x, y, nc)] %>% 
    .[]
}) %>% 
  rbindlist()


tb_goes %>%
  ggplot(aes(lon, lat)) +
  geom_scattermore(aes(color = tb)) +
  # scale_color_viridis_c() +
  scale_color_topes() +
  geom_mapa() +
  coord_sf(xlim = c(-78, -50), ylim = c(-42, -19)) +
  facet_wrap(~ channel, ncol = 5) +
  labs(title = "GOES-16") +
  theme_minimal() +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```



```{r echo=FALSE, fig.height=4, dpi=150}
tb_crtm <- ReadNetCDF("/home/paola.corrales/datosmunin/G16_20181122000000_012.nc") %>%
  .[, ":="(south_north = NULL,
           west_east = NULL)] 

colnames(tb_crtm) <- c("lat", "lon", paste0("C", formatC(7:16, width = 2, flag = 0)))

tb_crtm <- tb_crtm %>% 
  melt(measure.vars = patterns("C"), variable.name = "channel", value.name = "tb") %>% 
  .[, tb := tb - 273.15]

tb_crtm %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = tb)) +
  # scale_color_viridis_c() +
  scale_color_topes() +
  geom_mapa() +
  coord_sf(xlim = range(tb_crtm$lon), ylim = range(tb_crtm$lat)) +
  facet_wrap(~ channel, ncol = 5) +
  labs(title = "CRTM") +
  theme_minimal() +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```
## Aire claro

```{r echo=FALSE}
tb_goes[channel == "C15"] %>% 
  ggplot(aes(lon, lat)) +
  geom_scattermore(aes(color = tb)) +
  # scale_color_viridis_c() +
  scale_color_topes() +
  geom_rect(aes(xmin = -55, xmax = -52, ymin = -36, ymax = -33), 
            color = "red", fill = NA) +
  geom_rect(aes(xmin = -62, xmax = -58, ymin = -35, ymax = -31), 
            color = "red", fill = NA) +
  geom_mapa() +
  coord_sf(xlim = range(tb_crtm$lon), ylim = range(tb_crtm$lat)) +
  theme_minimal() +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```

```{r echo=FALSE}
# aire claro

xlim <- c(-55, -52)
ylim <- c(-36, -33)
set_channels <- c("C07", "C09", "C13", "C16")


aire_claro <- tb_crtm[lon %between% xlim & 
                        lat %between% ylim & channel %in% 
                        set_channels] %>% 
  setnames(old = "tb", new = "tb_crtm") 

points <- unique(aire_claro, by = c("lon", "lat"))
ac_goes <- tb_goes[lon %between% xlim & lat %between% ylim & channel %in% set_channels] %>% 
  .[, interp::interp(lon, lat, tb, 
                     xo = points$lon, 
                     yo = points$lat,
                     output = "points"),
    by = channel] %>% 
  setnames(c("x", "y", "z"), c("lon", "lat", "tb_goes"))

aire_claro <- ac_goes[aire_claro, on = c("channel", "lon", "lat")] %>% 
  .[, tierra := MaskLand(lon, lat, wrap = c(-180, 180))]

aire_claro %>% 
  melt(measure.vars = c("tb_crtm", "tb_goes"), value.name = "tb") %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = tb), size = 1) +
  scale_color_topes() +
  facet_grid(variable ~ channel) +
  theme_minimal()


```

```{r echo=FALSE}
aire_claro %>% 
  ggplot(aes(tb_crtm, tb_goes)) +
  geom_point(aes(color = tierra)) +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = c("deepskyblue4", "chartreuse4")) +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

```{r echo=FALSE}
aire_claro %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = tb_goes - tb_crtm)) +
  geom_abline(slope = 1, intercept = 0) +
  # scale_color_manual(values = c("deepskyblue4", "chartreuse4")) +
  scale_color_divergent() +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

```{r echo=FALSE}
aire_claro %>% 
  melt(measure.vars = c("tb_crtm", "tb_goes"), value.name = "tb") %>% 
  ggplot(aes(tb)) +
  geom_histogram(aes(fill = variable), 
                 position="identity", 
                 alpha = 0.5,
                 binwidth = 1) +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

## Con nubes

```{r echo=FALSE}
# nuboso

xlim <- c(-62, -58)
ylim <- c(-35, -31)
set_channels <- c("C07", "C09", "C13", "C16")


nuboso <- tb_crtm[lon %between% xlim & 
                    lat %between% ylim & channel %in% 
                    set_channels] %>% 
  setnames(old = "tb", new = "tb_crtm") 

points <- unique(nuboso, by = c("lon", "lat"))
nu_goes <- tb_goes[lon %between% xlim & 
                     lat %between% ylim & 
                     channel %in% set_channels] %>% 
  .[, interp::interp(lon, lat, tb, 
                     xo = points$lon, 
                     yo = points$lat,
                     output = "points"),
    by = channel] %>% 
  setnames(c("x", "y", "z"), c("lon", "lat", "tb_goes"))

nuboso <- nu_goes[nuboso, on = c("channel", "lon", "lat")] %>% 
  .[, tierra := MaskLand(lon, lat, wrap = c(-180, 180))]

nuboso %>% 
  melt(measure.vars = c("tb_crtm", "tb_goes"), value.name = "tb") %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = tb), size = 1) +
  scale_color_topes() +
  facet_grid(variable ~ channel) +
  theme_minimal()


```

```{r echo=FALSE}
nuboso %>% 
  ggplot(aes(tb_crtm, tb_goes)) +
  geom_point(aes(color = tierra)) +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = c("deepskyblue4", "chartreuse4")) +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

```{r echo=FALSE}
nuboso %>% 
  melt(measure.vars = c("tb_crtm", "tb_goes"), value.name = "tb") %>% 
  ggplot(aes(tb)) +
  geom_histogram(aes(fill = variable, y = ..density..), 
                 position = "identity", alpha = 0.7,
                 binwidth = 5) +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

# Corrección del BIAS

De acuerdo a la guía del usuario avanzda de GSI, para asimilar radiansas y que estas generen un impacto positivo en el prónosticos, es impresindible corregigir el bias asociado a cada instrumento y canal. 

GSI corrige el BIAS sobre la diferencia entre la observación y el background teniendo en cuenta dos posibles fuentes de BIAS:

- Air mass bias correction (corrección variacional): usa los coeficientes definidos en `satbias_in`
- Angle dependendat bias correction: asociado al ángulo de escaneo para cada punto y cuyos coeficientes se guardan en `satbias_angle`

Ambos set de coeficientes se deben ir actualizando en cada ciclo de asimilación, actualmente esa actualización se hace internamente (siempre que se configuren los argumentos necesarios en el namelist). De acuerdo a la guía los coeficientes para la correcciónn del bias tienen un spin up muy lento y deben ser entranados por semanas o meses. Una alternativa posibles es repetir cada ciclo de asimilación 10-12 veces antes de pasar al siguiente, cada vez actualizando los coeficientes. 

Una tercera opción sería probar con los coeficientes que se guardas en GDAS y que usa GFS. No necesariamente es una buena solución ya que son modelos distintos con distinta resolución y dominio. Pero tal vez se puede partir de esos coeficientes para que el spin up sea más corto (en comparación con empezar en 0).

Queda por responder ¿cómo se que los coeficientes ya están bien entrenados y puedo usarlos?

Funciones de peso: http://tropic.ssec.wisc.edu/real-time/amsu/explanation.html

## Lectura de coeficientes de GDAS

Maravillosamente los archivos en GDAS son de texto plano y tienen el formanto GSI friendly. Ahora me resulta obvio, pero nunca se sabe!

Entonces, hay un archivo cada 6 horas que se va actualizando.

- **gdas.txxz.abias y gdas.txxz.abias_pc**: Según la guía de GSI es "combined satellite angle dependent and mass bias correction coefficient file". El segundo para canales "pasivos" (que se monitorean).

Al parecer y de acuerdo a las versiones recientes de la guia de usuario, la correción del bias asociado al ángulo y el ¿modelos? ¿backgroud? se hace conjuntamente y por eso los coeficientes se combinan en un solo archivos. 

```{r}
# Es un archivo de texto plano, que emoción!!
satbias_in_file <- "/home/paola.corrales/datosmunin2/nomads.ncdc.noaa.gov/GDAS/201811/20181120/gdas.t00z.abias"
```

Para que la corrección se haga en conjunto es necesario indicarlo en el namelist:
`adp_anglebc = .true.`

```{bash eval=FALSE, include=FALSE}
# for satellite bias correction
cp ${OBS_ROOT}/gdas1.t12z.abias ./satbias_in
cp ${OBS_ROOT}/gdas1.t12z.abias_pc ./satbias_pc_in
```

**Archivos presentes en la salida de GSI**

- satbias_in: the input coefficients of bias correction for satellite radiance observations.
- satbias_out: the output coefficients of bias correction for satellite radiance observations
after the GSI run.
- satbias_pc: the input coefficients of bias correction for passive satellite radiance observations
- satbias_pc.out


## Prueba de asimilación
```{r}
ana_file <- "/home/paola.corrales/datosmunin/EXP/analysis.ensmean"
ana <- ReadNetCDF(ana_file, vars = c(p = "P", "PB", t = "T", qv = "QVAPOR", 
                                 lon = "XLONG", lat = "XLAT")) %>%
    .[, p := p + PB] %>%
    .[, t := tk(t, p)] %>%
    .[, rh := rh(qv, p, t)] %>% 
    .[, td := td(qv, p) + 273.15] %>% 
    .[, ":="(Time = NULL,
             west_east = NULL,
             south_north = NULL,
             qv = NULL,
             PB = NULL)] %>% 
    .[, c("u", "v") := uvmet(ana_file)] %>% 
  .[, file := "ana"]

guess_file <- "/home/paola.corrales/datosmunin/EXP/wrfarw.ensmean"
guess <- ReadNetCDF(guess_file, vars = c(p = "P", "PB", t = "T", qv = "QVAPOR", 
                                 lon = "XLONG", lat = "XLAT")) %>%
    .[, p := p + PB] %>%
    .[, t := tk(t, p)] %>%
    .[, rh := rh(qv, p, t)] %>% 
    .[, td := td(qv, p) + 273.15] %>% 
    .[, ":="(Time = NULL,
             west_east = NULL,
             south_north = NULL,
             qv = NULL,
             PB = NULL)] %>% 
    .[, c("u", "v") := uvmet(ana_file)] %>% 
    .[, file := "guess"]

dt <- rbind(ana, guess)
```

```{r}
dt[bottom_top %in% seq(1, 35, 4)] %>% 
  dcast(bottom_top + lon + lat ~ file, value.var = "t") %>% 
  .[, diff_t := ana - guess] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = diff_t)) +
  scale_color_divergent() +
  geom_mapa() +
  coord_sf(xlim = c(-78, -50), ylim = c(-42, -19)) +
  facet_wrap(~ bottom_top) +
  theme_minimal()

dt[bottom_top %in% seq(1, 35, 4)] %>% 
  dcast(bottom_top + lon + lat ~ file, value.var = "p") %>% 
  .[, diff_p := ana - guess] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = diff_p)) +
  scale_color_divergent() +
  geom_mapa() +
  coord_sf(xlim = c(-78, -50), ylim = c(-42, -19)) +
  facet_wrap(~ bottom_top) +
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
diag_file <- read_diag_mean("analisis/diagfiles/", c("uv", "t", "p"))

diag <- fread("analisis/diagfiles/asim_conv_20181121020000.ensmean") %>% 
  .[V10 == 1] %>% 
  .[, date := ymd_hms(20181121020000)] %>% 
  .[, c("V2", "V4") := NULL]

# cat("Archivo ", basename(files[f]))

colnames(diag) <- c("var", "stationID", "type", "dhr", "lat", "lon", "pressure", "usage.flag", "flag.prep", "obs", "obs.guess", "obs2", "obs.guess2", "rerr", "date")

uv <- diag[var == "uv"] %>% 
  melt(measure.vars = c("obs", "obs2", "obs.guess", "obs.guess2")) %>% 
  .[, var := if_else(str_detect(variable, "2"), "v", "u")] %>% 
  .[, variable := str_remove(variable, "2")] 

vars <- rlang::syms(setdiff(names(uv), "value")) 
uv <- uv %>% 
  distinct(!!!vars, .keep_all = TRUE) %>% 
  pivot_wider(names_from = variable, values_from = value) %>% 
  setDT

variable <- c(unique(diag$var), "u", "v")

diag <- diag[var != "uv", -c("obs2", "obs.guess2"), with = FALSE] %>% 
  rbind(uv) %>% 
  .[var %in% variable] %>% 
  .[, id := 1:.N] 

diag <-  diag[, c("xp", "yp") := wrf_project(lon, lat, round = FALSE)]

diag_unique <- unique(diag, by = c("xp", "yp"))

ana_obs <- ana[] %>% 
      melt(id.vars = c("bottom_top", "lon", "lat")) %>%
  .[variable %in% c("t", "p") & bottom_top %between% c(1, 3)] %>% 
      .[, c("xp", "yp") := wrf_project(lon, lat)] %>%
      .[, interp_lite(xp, yp, value, 
                      xo = diag_unique[var %in% c("t", "p")]$xp, 
                      yo = diag_unique[var %in% c("t", "p")]$yp,
                      output = "points"),
        by = .(bottom_top, variable)]


ana_obs <- ana_obs[variable != "p"] %>% 
    .[ana_obs[variable == "p"], on = c("bottom_top", "x", "y")] %>% 
    setnames(c("x", "y", "z", "i.z"), c("xp", "yp", "value", "p"))
  
diag <- diag[var != "q"] %>% 
    melt(measure.vars = c("t", "u", "v")) %>% 
    .[, fcst_value := approx_safe(.BY$xp, .BY$yp, .BY$variable, p), 
      by = .(xp, yp, variable)]


```


```{r}

files <- list.files("analisis/satbias/E7", pattern = "satbias_2", full.names = TRUE)

satbias <- map(files, function(f){
  meta <- unglue::unglue(f, "analisis/satbias/{exp}/satbias_{date}")
  read_satbias(f) %>% 
    as.data.table() %>% 
    .[, ":="(exp = meta[[1]][["exp"]],
             date = ymd_h(meta[[1]][["date"]]))]
  
}) %>% 
  rbindlist()

sensores <- c("amsua_n15",
              "amsua_n18",
              "amsua_metop_a",
              "amsua_aqua",
              "airs_aqua",
              "hirs4_n19",
              "hirs4_metop-a"
              )

satbias[sensor == "amsua_n15" & channel == 2] %>% 
  melt(measure.vars = paste0("pred", seq_len(12))) %>% 
  ggplot(aes(date, value)) +
  geom_line() +
  facet_wrap(~variable, scales = "free_y")
```

! radiance bias correction terms are as follows:
!  pred(1,:)  = global offset
!  pred(2,:)  = zenith angle predictor, is not used and set to zero now
!  pred(3,:)  = cloud liquid water predictor for clear-sky microwave radiance assimilation
!  pred(4,:)  = square of temperature laps rate predictor
!  pred(5,:)  = temperature laps rate predictor
!  pred(6,:)  = cosinusoidal predictor for SSMI/S ascending/descending bias
!  pred(7,:)  = sinusoidal predictor for SSMI/S
!  pred(8,:)  = emissivity sensitivity predictor for land/sea differences
!  pred(9,:)  = fourth order polynomial of angle bias correction
!  pred(10,:) = third order polynomial of angle bias correction
!  pred(11,:) = second order polynomial of angle bias correction
!  pred(12,:) = first order polynomial of angle bias correction


```{r}
files <- list.files("analisis/diagfiles/E7", pattern = "asim", full.names = TRUE)
diag <- map(files, function(f){
  meta <- unglue::unglue(f, "analisis/diagfiles/{exp}/asim_{sensor}_{plat}_{date}.ensmean")
  # print(f)
  out <- fread(f)
    # .[V10 == 1] %>% 
    
  if (file.size(f) != 0) {
    out[, date := ymd_hms(meta[[1]][["date"]])]
  }
  out
}) %>%
  rbindlist()
# cat("Archivo ", basename(files[f]))

colnames(diag) <- c("sensor", "channel", "lat", "lon", "press", "dhr", "tb_obs", "tbc", "tbcnob",
                    "errinv", "qc", "emis", "tlapchn", "rzen", "razi", "rlnd", "rice", "rsnw", "rcld", 
                    "rcldp", paste0("pred", seq(8)), "date")

diag[channel %in% c(1:4, 6, 7)] %>% 
  melt(measure.vars = c("tbcnob", "tbc")) %>% 
  ggplot(aes(value)) +
  geom_density(aes(color = variable)) +
  geom_vline(xintercept = 0) +
    facet_wrap(~channel, scales = "free") +
  labs(x = "Obs - Guess") +
  theme_minimal() +
  theme(legend.position = "bottom")
```


```{r}
diag[sensor == "amsua_n15" & channel %in% c(1, 2, 3, 6, 15)] %>% 
  .[date == date[1]] %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = tbc - tbcnob)) +
  scale_color_divergent() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  facet_wrap(~channel, ncol = 3) +
  theme_minimal()

diag[sensor == "amsua_n15" & channel == 2] %>% 
  .[date == date[1]] %>% 
  melt(measure.vars = paste0("pred", seq(8))) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = value)) +
  scale_color_viridis_c() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  facet_wrap(~variable, ncol = 4) +
  theme_minimal()

```

```{r}
diag[sensor %in% c("amsua_aqua", "amsua_metop-a", "amsua_n15", "amsua_n18")] %>% 
  ggplot(aes(factor(channel), tbc - tbcnob)) +
  geom_boxplot() +
  facet_wrap(~sensor)

# diag[sensor %in% c("airs_aqua") & channel < 300] %>% 
#   ggplot(aes(channel, tbc - tbcnob)) +
#   geom_boxplot(aes(group = channel))
```


## Nueva prueba asimilando solo AMSU-A de NOAA-18

```{r}

files <- list.files("analisis/diagfiles/", pattern = "amsua_n15", full.names = TRUE)

diag <- map(files, function(f) {
  var_names <- GlanceNetCDF(f) %>% 
  .$vars %>% 
  names()

diag <- ReadNetCDF(f, vars = var_names[c(10, 12, 13, 55:79)]) %>% 
  .[, file := f]
}) %>% 
  rbindlist()

diag[Channel_Index %in% c(1:4, 6, 7)] %>% 
  melt(measure.vars = c("Obs_Minus_Forecast_unadjusted", "Obs_Minus_Forecast_adjusted")) %>% 
  ggplot(aes(value)) +
  geom_density(aes(color = variable)) +
  geom_vline(xintercept = 0) +
    facet_wrap(~Channel_Index, scales = "free") +
  labs(x = "Obs - Guess") +
  theme_minimal() +
  theme(legend.position = "bottom")

```


```{r}
diag %>% 
  melt(measure.vars = patterns("^BC_")) %>% 
  ggplot(aes(ConvertLongitude(Longitude), Latitude)) +
  geom_point(aes(color = value)) +
  scale_color_viridis_c() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  facet_wrap(~variable, ncol = 4) +
  theme_minimal()

diag[Channel_Index == 2] %>% 

  ggplot(aes(ConvertLongitude(Longitude), Latitude)) +
  geom_point(aes(color = file)) +
  # scale_color_viridis_c() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  # facet_wrap(~variable, ncol = 4) +
  theme_minimal()

```

