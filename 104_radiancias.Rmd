---
title: "104_radiancias"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(metR)
library(data.table)
library(lubridate)
library(scattermore)
library(patchwork)
source("help_functions.R")
source("postprocesamiento.R")
source("goes_functions.R")

map <- rnaturalearth::ne_states(country = c("argentina", "Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")

geom_mapa <- function() {
  geom_sf(data = map, fill = NA, color = "black", size = 0.2, inherit.aes = FALSE)
}
```

## GOES 16

Canales en la región del infrarrojo

| Canal | Longitud de onda Central $\mu m$ | Observaciones | Función de peso |
|:-----:|:----------:|:------------------------------------|:----------------------------|
|  7  |  3.9  | Sensible tanto a la radiación del sol como a la emitida por la Tierra | Maxímo en superficie |
|  8  |  6.2  | Sensible al vapor de agua | Máximo en 425 hPa. |
|  9  |  6.9  | Predomina la absorción por vapor de agua | Maxímo cercano a 460 hPa. |
| 10  |  7.3  | Sensible al vapor de agua | Máximo en 640 hPa. |
| 11  |  8.4  | Para estudio de microfísica de nubes y plumas volcánicas con ceniza y dióxido de sulfuro | Máximo en niveles bajos |
| 12  |  9.6  | Absorción por ozono  | Máximo en la estratósfera |
| 13  | 10.3  | Ventana radiativa, absorción despresiable en la atmósfera. Cerca del $\lambda$ de máxima emisión terrestre | Máximo en superficie |
| 14  | 11.2  | Ventana radiativa con mayor absorción de vapor de agua | |
| 15  | 12.3  | Ventana radiativa con mayor absorción de vapor de agua | |
| 16  | 13.3  | Absorción por dióxido de carbono | Máximo cerca de superficie |


Al parecer las observaciones de GOES vienen en archivos .nc, uno por canal en radiancias. 


```{r echo=FALSE, fig.height=4, dpi=150}
files <- list.files(path = "/home/paola.corrales/datosmunin/DA/DA_DATA/GOES16/", pattern = "nc", full.names = TRUE)

#dominio de interés
xlim <- c(2600, 3950)
ylim <- c(3700, 4750)

tb_goes <- purrr::map(files, function(f) {
  
  meta <- unglue::unglue(basename(f), "OR_ABI-L1b-RadF-M3{channel}_G16_s{sdate}_e{edate}_c{cdate}.nc")
  nc <- ncdf4::nc_open(f)
  # mu <- ncvar_get(nc, "band_wavelength")*1e-6
  out <- ReadNetCDF(f, vars = c(rad = "Rad", qf = "DQF"), 
                    subset = list(x = xlim, y = ylim)) %>% 
    .[, rad := calculate_rad(rad, nc)] %>% 
    .[, tb := rad_to_tb(rad, nc)] %>% 
    .[, channel := meta[[1]][["channel"]]] %>% 
    .[, c("lon", "lat") := goes_projection(x, y, nc)] %>% 
    .[]
}) %>% 
  rbindlist()


tb_goes %>%
  ggplot(aes(lon, lat)) +
  geom_scattermore(aes(color = tb)) +
  # scale_color_viridis_c() +
  scale_color_topes() +
  geom_mapa() +
  coord_sf(xlim = c(-78, -50), ylim = c(-42, -19)) +
  facet_wrap(~ channel, ncol = 5) +
  labs(title = "GOES-16") +
  theme_minimal() +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```



```{r echo=FALSE, fig.height=4, dpi=150}
tb_crtm <- ReadNetCDF("/home/paola.corrales/datosmunin/G16_20181122000000_012.nc") %>%
  .[, ":="(south_north = NULL,
           west_east = NULL)] 

colnames(tb_crtm) <- c("lat", "lon", paste0("C", formatC(7:16, width = 2, flag = 0)))

tb_crtm <- tb_crtm %>% 
  melt(measure.vars = patterns("C"), variable.name = "channel", value.name = "tb") %>% 
  .[, tb := tb - 273.15]

tb_crtm %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = tb)) +
  # scale_color_viridis_c() +
  scale_color_topes() +
  geom_mapa() +
  coord_sf(xlim = range(tb_crtm$lon), ylim = range(tb_crtm$lat)) +
  facet_wrap(~ channel, ncol = 5) +
  labs(title = "CRTM") +
  theme_minimal() +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```
## Aire claro

```{r echo=FALSE}
tb_goes[channel == "C15"] %>% 
  ggplot(aes(lon, lat)) +
  geom_scattermore(aes(color = tb)) +
  # scale_color_viridis_c() +
  scale_color_topes() +
  geom_rect(aes(xmin = -55, xmax = -52, ymin = -36, ymax = -33), 
            color = "red", fill = NA) +
  geom_rect(aes(xmin = -62, xmax = -58, ymin = -35, ymax = -31), 
            color = "red", fill = NA) +
  geom_mapa() +
  coord_sf(xlim = range(tb_crtm$lon), ylim = range(tb_crtm$lat)) +
  theme_minimal() +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```

```{r echo=FALSE}
# aire claro

xlim <- c(-55, -52)
ylim <- c(-36, -33)
set_channels <- c("C07", "C09", "C13", "C16")


aire_claro <- tb_crtm[lon %between% xlim & 
                        lat %between% ylim & channel %in% 
                        set_channels] %>% 
  setnames(old = "tb", new = "tb_crtm") 

points <- unique(aire_claro, by = c("lon", "lat"))
ac_goes <- tb_goes[lon %between% xlim & lat %between% ylim & channel %in% set_channels] %>% 
  .[, interp::interp(lon, lat, tb, 
                     xo = points$lon, 
                     yo = points$lat,
                     output = "points"),
    by = channel] %>% 
  setnames(c("x", "y", "z"), c("lon", "lat", "tb_goes"))

aire_claro <- ac_goes[aire_claro, on = c("channel", "lon", "lat")] %>% 
  .[, tierra := MaskLand(lon, lat, wrap = c(-180, 180))]

aire_claro %>% 
  melt(measure.vars = c("tb_crtm", "tb_goes"), value.name = "tb") %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = tb), size = 1) +
  scale_color_topes() +
  facet_grid(variable ~ channel) +
  theme_minimal()


```

```{r echo=FALSE}
aire_claro %>% 
  ggplot(aes(tb_crtm, tb_goes)) +
  geom_point(aes(color = tierra)) +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = c("deepskyblue4", "chartreuse4")) +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

```{r echo=FALSE}
aire_claro %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = tb_goes - tb_crtm)) +
  geom_abline(slope = 1, intercept = 0) +
  # scale_color_manual(values = c("deepskyblue4", "chartreuse4")) +
  scale_color_divergent() +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

```{r echo=FALSE}
aire_claro %>% 
  melt(measure.vars = c("tb_crtm", "tb_goes"), value.name = "tb") %>% 
  ggplot(aes(tb)) +
  geom_histogram(aes(fill = variable), 
                 position="identity", 
                 alpha = 0.5,
                 binwidth = 1) +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

## Con nubes

```{r echo=FALSE}
# nuboso

xlim <- c(-62, -58)
ylim <- c(-35, -31)
set_channels <- c("C07", "C09", "C13", "C16")


nuboso <- tb_crtm[lon %between% xlim & 
                    lat %between% ylim & channel %in% 
                    set_channels] %>% 
  setnames(old = "tb", new = "tb_crtm") 

points <- unique(nuboso, by = c("lon", "lat"))
nu_goes <- tb_goes[lon %between% xlim & 
                     lat %between% ylim & 
                     channel %in% set_channels] %>% 
  .[, interp::interp(lon, lat, tb, 
                     xo = points$lon, 
                     yo = points$lat,
                     output = "points"),
    by = channel] %>% 
  setnames(c("x", "y", "z"), c("lon", "lat", "tb_goes"))

nuboso <- nu_goes[nuboso, on = c("channel", "lon", "lat")] %>% 
  .[, tierra := MaskLand(lon, lat, wrap = c(-180, 180))]

nuboso %>% 
  melt(measure.vars = c("tb_crtm", "tb_goes"), value.name = "tb") %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = tb), size = 1) +
  scale_color_topes() +
  facet_grid(variable ~ channel) +
  theme_minimal()


```

```{r echo=FALSE}
nuboso %>% 
  ggplot(aes(tb_crtm, tb_goes)) +
  geom_point(aes(color = tierra)) +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = c("deepskyblue4", "chartreuse4")) +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

```{r echo=FALSE}
nuboso %>% 
  melt(measure.vars = c("tb_crtm", "tb_goes"), value.name = "tb") %>% 
  ggplot(aes(tb)) +
  geom_histogram(aes(fill = variable, y = ..density..), 
                 position = "identity", alpha = 0.7,
                 binwidth = 5) +
  facet_wrap(~ channel, scales = "free") +
  theme_minimal()
```

# Corrección del BIAS

De acuerdo a la guía del usuario avanzda de GSI, para asimilar radiansas y que estas generen un impacto positivo en el prónosticos, es impresindible corregigir el bias asociado a cada instrumento y canal. 

GSI corrige el BIAS sobre la diferencia entre la observación y el background teniendo en cuenta dos posibles fuentes de BIAS:

- Air mass bias correction (corrección variacional): usa los coeficientes definidos en `satbias_in`
- Angle dependendat bias correction: asociado al ángulo de escaneo para cada punto y cuyos coeficientes se guardan en `satbias_angle`

Ambos set de coeficientes se deben ir actualizando en cada ciclo de asimilación, actualmente esa actualización se hace internamente (siempre que se configuren los argumentos necesarios en el namelist). De acuerdo a la guía los coeficientes para la correcciónn del bias tienen un spin up muy lento y deben ser entranados por semanas o meses. Una alternativa posibles es repetir cada ciclo de asimilación 10-12 veces antes de pasar al siguiente, cada vez actualizando los coeficientes. 

Una tercera opción sería probar con los coeficientes que se guardas en GDAS y que usa GFS. No necesariamente es una buena solución ya que son modelos distintos con distinta resolución y dominio. Pero tal vez se puede partir de esos coeficientes para que el spin up sea más corto (en comparación con empezar en 0).

Queda por responder ¿cómo se que los coeficientes ya están bien entrenados y puedo usarlos?

Funciones de peso: http://tropic.ssec.wisc.edu/real-time/amsu/explanation.html

## Lectura de coeficientes de GDAS

Maravillosamente los archivos en GDAS son de texto plano y tienen el formanto GSI friendly. Ahora me resulta obvio, pero nunca se sabe!

Entonces, hay un archivo cada 6 horas que se va actualizando.

- **gdas.txxz.abias y gdas.txxz.abias_pc**: Según la guía de GSI es "combined satellite angle dependent and mass bias correction coefficient file". El segundo para canales "pasivos" (que se monitorean).

Al parecer y de acuerdo a las versiones recientes de la guia de usuario, la correción del bias asociado al ángulo y el ¿modelos? ¿backgroud? se hace conjuntamente y por eso los coeficientes se combinan en un solo archivos. 

```{r}
# Es un archivo de texto plano, que emoción!!
satbias_in_file <- "/home/paola.corrales/datosmunin2/nomads.ncdc.noaa.gov/GDAS/201811/20181120/gdas.t00z.abias"
```

Para que la corrección se haga en conjunto es necesario indicarlo en el namelist:
`adp_anglebc = .true.`

```{bash eval=FALSE, include=FALSE}
# for satellite bias correction
cp ${OBS_ROOT}/gdas1.t12z.abias ./satbias_in
cp ${OBS_ROOT}/gdas1.t12z.abias_pc ./satbias_pc_in
```

**Archivos presentes en la salida de GSI**

- satbias_in: the input coefficients of bias correction for satellite radiance observations.
- satbias_out: the output coefficients of bias correction for satellite radiance observations
after the GSI run.
- satbias_pc: the input coefficients of bias correction for passive satellite radiance observations
- satbias_pc.out


## Prueba de asimilación
```{r}
ana_file <- "/home/paola.corrales/datosmunin/EXP/analysis.ensmean"
ana <- ReadNetCDF(ana_file, vars = c(p = "P", "PB", t = "T", qv = "QVAPOR", 
                                     lon = "XLONG", lat = "XLAT")) %>%
  .[, p := p + PB] %>%
  .[, t := tk(t, p)] %>%
  .[, rh := rh(qv, p, t)] %>% 
  .[, td := td(qv, p) + 273.15] %>% 
  .[, ":="(Time = NULL,
           west_east = NULL,
           south_north = NULL,
           qv = NULL,
           PB = NULL)] %>% 
  .[, c("u", "v") := uvmet(ana_file)] %>% 
  .[, file := "ana"]

guess_file <- "/home/paola.corrales/datosmunin/EXP/wrfarw.ensmean"
guess <- ReadNetCDF(guess_file, vars = c(p = "P", "PB", t = "T", qv = "QVAPOR", 
                                         lon = "XLONG", lat = "XLAT")) %>%
  .[, p := p + PB] %>%
  .[, t := tk(t, p)] %>%
  .[, rh := rh(qv, p, t)] %>% 
  .[, td := td(qv, p) + 273.15] %>% 
  .[, ":="(Time = NULL,
           west_east = NULL,
           south_north = NULL,
           qv = NULL,
           PB = NULL)] %>% 
  .[, c("u", "v") := uvmet(ana_file)] %>% 
  .[, file := "guess"]

dt <- rbind(ana, guess)
```

```{r}
dt[bottom_top %in% seq(1, 35, 4)] %>% 
  dcast(bottom_top + lon + lat ~ file, value.var = "t") %>% 
  .[, diff_t := ana - guess] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = diff_t)) +
  scale_color_divergent() +
  geom_mapa() +
  coord_sf(xlim = c(-78, -50), ylim = c(-42, -19)) +
  facet_wrap(~ bottom_top) +
  theme_minimal()

dt[bottom_top %in% seq(1, 35, 4)] %>% 
  dcast(bottom_top + lon + lat ~ file, value.var = "p") %>% 
  .[, diff_p := ana - guess] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = diff_p)) +
  scale_color_divergent() +
  geom_mapa() +
  coord_sf(xlim = c(-78, -50), ylim = c(-42, -19)) +
  facet_wrap(~ bottom_top) +
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
diag_file <- read_diag_mean("analisis/diagfiles/", c("uv", "t", "p"))

diag <- fread("analisis/diagfiles/asim_conv_20181121020000.ensmean") %>% 
  .[V10 == 1] %>% 
  .[, date := ymd_hms(20181121020000)] %>% 
  .[, c("V2", "V4") := NULL]

# cat("Archivo ", basename(files[f]))

colnames(diag) <- c("var", "stationID", "type", "dhr", "lat", "lon", "pressure", "usage.flag", "flag.prep", "obs", "obs.guess", "obs2", "obs.guess2", "rerr", "date")

uv <- diag[var == "uv"] %>% 
  melt(measure.vars = c("obs", "obs2", "obs.guess", "obs.guess2")) %>% 
  .[, var := if_else(str_detect(variable, "2"), "v", "u")] %>% 
  .[, variable := str_remove(variable, "2")] 

vars <- rlang::syms(setdiff(names(uv), "value")) 
uv <- uv %>% 
  distinct(!!!vars, .keep_all = TRUE) %>% 
  pivot_wider(names_from = variable, values_from = value) %>% 
  setDT

variable <- c(unique(diag$var), "u", "v")

diag <- diag[var != "uv", -c("obs2", "obs.guess2"), with = FALSE] %>% 
  rbind(uv) %>% 
  .[var %in% variable] %>% 
  .[, id := 1:.N] 

diag <-  diag[, c("xp", "yp") := wrf_project(lon, lat, round = FALSE)]

diag_unique <- unique(diag, by = c("xp", "yp"))

ana_obs <- ana[] %>% 
  melt(id.vars = c("bottom_top", "lon", "lat")) %>%
  .[variable %in% c("t", "p") & bottom_top %between% c(1, 3)] %>% 
  .[, c("xp", "yp") := wrf_project(lon, lat)] %>%
  .[, interp_lite(xp, yp, value, 
                  xo = diag_unique[var %in% c("t", "p")]$xp, 
                  yo = diag_unique[var %in% c("t", "p")]$yp,
                  output = "points"),
    by = .(bottom_top, variable)]


ana_obs <- ana_obs[variable != "p"] %>% 
  .[ana_obs[variable == "p"], on = c("bottom_top", "x", "y")] %>% 
  setnames(c("x", "y", "z", "i.z"), c("xp", "yp", "value", "p"))

diag <- diag[var != "q"] %>% 
  melt(measure.vars = c("t", "u", "v")) %>% 
  .[, fcst_value := approx_safe(.BY$xp, .BY$yp, .BY$variable, p), 
    by = .(xp, yp, variable)]


```

## Actualización de coeficientes

En la etapa del LETKF la subrutina `update_biascorr()` se encarga de actualizar los coeficientes que se usan en la corrección del bias aplicando la metodología propuesta por Miyoshi et. al. (2010) y que según Zhu et. al. (2019) en análoga a la versión variacional que utiliza GSI. En el mismo paper indican que la optimización con filtro de kalman en algunos casos funciona mejor y esto podría doberse a que es menos sensible al tamaño de la muestra (cantidad de observaciones).

La rutina calcula el incremento de los coeficientes $\delta \beta$ de la siguiente manera:

$$\delta \beta = (B_{\beta}^{-1} + P R^{-1}P^{T})^{-1}PR^{-1}[y-H(x)-P^T\beta]$$

Donde $B^{-1}_\beta$ la matriz de covarianza de los coeficientes es diagonal y sus elementos valen 0.1.

La estimación de $\delta \beta$ se realiza iterativamente tantas veces como el argumento `numiter` del namelist lo indique (por defecto 6).

Previamente al cálculo del incremento se realiza una estimación adaptativa de la varianza de los errores que impacta en la matriz $B$. Actualmente el algoritmo tiene en cuenta: 

- Si es la primera vez que se asimila ese canal/sensor (revisar): $biaservar = 10000$
- Si en algún ciclo no hay observaciones de un canal/sensor: $biaservar = 2*biaservar + 1e-6$ (con un tope de $biaservar = 10$)
- O, si eso está desectivado puede tomar un valor fijo dividido la cantidad de observaciones.



```{r echo=FALSE}

files <- list.files("analisis/satbias/E7", pattern = "satbias_2", full.names = TRUE)

satbias <- map(files, function(f){
  meta <- unglue::unglue(f, "analisis/satbias/{exp}/satbias_{date}")
  read_satbias(f) %>% 
    as.data.table() %>% 
    .[, ":="(exp = meta[[1]][["exp"]],
             date = ymd_h(meta[[1]][["date"]]))]
  
}) %>% 
  rbindlist()

sensores <- c("amsua_n15",
              "amsua_n18",
              "amsua_metop_a",
              "amsua_aqua",
              "airs_aqua",
              "hirs4_n19",
              "hirs4_metop-a",
              "mhs_metop-a",
              "mhs_n19"
)

satbias[sensor %in% sensores[1] & channel %in% c(4)] %>% 
  melt(measure.vars = paste0("coeff", seq(3, 5))) %>% 
  ggplot(aes(date, value)) +
  geom_point(aes(group = channel), size= 0.5) +
  geom_path(aes(group = channel), size= 0.5) +
  labs(title = paste("Coefficientes for", sensores[1]),
       subtitle = "Channel 4") +
  facet_wrap(~variable, scales = "free_y", 
             labeller = labeller(variable = c("coeff3" = "CLW",
                                              "coeff4" = "TLR^2",
                                              "coeff5" = "TLR"))) +
  theme_minimal() +
  satbias[sensor %in% sensores[1] & channel %in% c(5)] %>% 
  melt(measure.vars = paste0("coeff", seq(3, 5))) %>% 
  ggplot(aes(date, value)) +
  geom_point(aes(group = channel), size= 0.5) +
  geom_path(aes(group = channel), size= 0.5) +
  labs(subtitle = "Channel 5") +
  facet_wrap(~variable, scales = "free_y", 
             labeller = labeller(variable = c("coeff3" = "CLW",
                                              "coeff4" = "TLR^2",
                                              "coeff5" = "TLR"))) +
  theme_minimal() +
  satbias[sensor %in% sensores[1] & channel %in% c(7)] %>% 
  melt(measure.vars = paste0("coeff", seq(3, 5))) %>% 
  ggplot(aes(date, value)) +
  geom_point(aes(group = channel), size= 0.5) +
  geom_path(aes(group = channel), size= 0.5) +
  labs(subtitle = "Channel 7") +
  facet_wrap(~variable, scales = "free_y", 
             labeller = labeller(variable = c("coeff3" = "CLW",
                                              "coeff4" = "TLR^2",
                                              "coeff5" = "TLR"))) +
  theme_minimal() +
  
  satbias[sensor %in% sensores[1] & channel %in% c(8)] %>% 
  melt(measure.vars = paste0("coeff", seq(3, 5))) %>% 
  ggplot(aes(date, value)) +
  geom_point(aes(group = channel), size= 0.5) +
  geom_path(aes(group = channel), size= 0.5) +
  labs(subtitle = "Channel 8") +
  facet_wrap(~variable, scales = "free_y", 
             labeller = labeller(variable = c("coeff3" = "CLW",
                                              "coeff4" = "TLR^2",
                                              "coeff5" = "TLR"))) +
  theme_minimal() +
  plot_layout(ncol = 1)
```

### Predictores 

Según el código los predictores $p_i$ son:

- pred(1,:)  = global offset
- pred(2,:)  = zenith angle predictor, is not used and set to zero now
- pred(3,:)  = cloud liquid water predictor for clear-sky microwave radiance assimilation
- pred(4,:)  = square of temperature laps rate predictor
- pred(5,:)  = temperature laps rate predictor
- pred(6,:)  = cosinusoidal predictor for SSMI/S ascending/descending bias
- pred(7,:)  = sinusoidal predictor for SSMI/S
- pred(8,:)  = emissivity sensitivity predictor for land/sea differences
- pred(9,:)  = fourth order polynomial of angle bias correction
- pred(10,:) = third order polynomial of angle bias correction
- pred(11,:) = second order polynomial of angle bias correction
- pred(12,:) = first order polynomial of angle bias correction


Se calculan utilizando información del guess y de la observación de radianza y luego se utilizan para calcular la corrección del bias para cada observación y que será aplicada sobre el *incremento*.

$$ tbc = tbcnob + \sum_{i} p_i (\beta + \delta \beta)$$

```{r}
files <- list.files("analisis/diagfiles/E7", pattern = "asim", full.names = TRUE) %>%
  .[!str_detect(., "conv")]
diag <- map(files, function(f){
  meta <- unglue::unglue(f, "analisis/diagfiles/{exp}/asim_{sensor}_{plat}_{date}.ensmean")
  # print(f)
  out <- fread(f)
  # .[V10 == 1] %>% 
  
  if (file.size(f) != 0) {
    out[, date := ymd_hms(meta[[1]][["date"]])]
  }
  out
}) %>%
  rbindlist()

colnames(diag) <- c("sensor", "channel", "lat", "lon", "press", "dhr", "tb_obs", "tbc", "tbcnob",
                    "errinv", "qc", "emis", "tlapchn", "rzen", "razi", "rlnd", "rice", "rsnw", "rcld", 
                    "rcldp", paste0("pred", seq(8)), "date")

diag[sensor == "amsua_n15" & channel %in% c(1:10)] %>% 
  melt(measure.vars = c("tbcnob", "tbc")) %>% 
  .[, .(mean = mean(value),
        sd = sd(value)), by = .(variable, channel, date)] %>% 
  melt(measure.vars = c("mean", "sd"), variable.name = "estadistico") %>% 
  ggplot(aes(date, value)) +
  geom_point(aes(color = variable)) +
  geom_path(aes(color = variable, linetype = estadistico)) +
  scale_color_brewer(name = NULL, palette = "Set1", labels = c("tbcnob" = "sin BC",
                                                               "tbc" = "con BC")) +
  # geom_vline(xintercept = 0) +
  facet_wrap(~channel, scales = "free") +
  labs(x = "Obs - Guess") +
  theme_minimal() +
  theme(legend.position = "bottom")
```


```{r}
diag[sensor == "amsua_n15" & channel %in% c(1:8)] %>% 
  .[date == date[1]] %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = tbc - tbcnob)) +
  scale_color_divergent(name = "BIAS") +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  labs(title = "amsua_n15",
       x = "", y = "") +
  facet_wrap(~channel, ncol = 4) +
  theme_minimal()

diag[sensor == "amsua_n15" & channel %in% c(1:8)] %>% 
  .[date == date[1]] %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = press)) +
  # scale_color_divergent(name = "BIAS") +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  labs(title = "amsua_n15",
       x = "", y = "") +
  facet_wrap(~channel, ncol = 4) +
  theme_minimal()
diag[sensor == "amsua_n15" & channel %in% c(1:8)] %>% 
  ggplot(aes(press)) +
  geom_density(aes(group =  channel, color = channel))

```
Pred2 = 1
Pred3 = 0
Pred7 = 0
Pred8 = 0

```{r echo=FALSE}
diag[sensor == "amsua_n15" & channel == 2] %>% 
  # .[date == date[1]] %>% 
  .[, date := factor(date)] %>% 
  melt(measure.vars = paste0("pred", c(1))) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = value), size = 1) +
  scale_color_viridis_c() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  labs(title = "Pred1",
       x = "", y = "") +
  facet_wrap(~date, ncol = 5) +
  theme_minimal()

diag[sensor == "amsua_n15" & channel == 2] %>% 
  # .[date == date[1]] %>% 
  .[, date := factor(date)] %>% 
  melt(measure.vars = paste0("pred", c(4))) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = value), size = 1) +
  scale_color_viridis_c() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  labs(title = "Pred4",
       x = "", y = "") +
  facet_wrap(~date, ncol = 5) +
  theme_minimal()


diag[sensor == "amsua_n15" & channel == 2] %>% 
  # .[date == date[1]] %>% 
  .[, date := factor(date)] %>% 
  melt(measure.vars = paste0("pred", c(5))) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = value), size = 1) +
  scale_color_viridis_c() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  labs(title = "Pred5",
       x = "", y = "") +
  facet_wrap(~date, ncol = 5) +
  theme_minimal()

diag[sensor == "amsua_n15" & channel == 2] %>% 
  # .[date == date[1]] %>% 
  .[, date := factor(date)] %>% 
  melt(measure.vars = paste0("pred", c(6))) %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = value), size = 1) +
  scale_color_viridis_c() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  labs(title = "Pred6",
       x = "", y = "") +
  facet_wrap(~date, ncol = 5) +
  theme_minimal()

```

```{r}
diag[sensor %in% c("amsua_n15")] %>% 
  ggplot(aes(factor(channel), tbc - tbcnob)) +
  geom_hline(yintercept = 0, color = "darkorange") +
  geom_boxplot() +
  labs(x = "Channel", y = "BIAS") +
  facet_wrap(~sensor) +
  theme_minimal()

# diag[sensor %in% c("airs_aqua") & channel < 300] %>% 
#   ggplot(aes(channel, tbc - tbcnob)) +
#   geom_boxplot(aes(group = channel))
```


## Prueba de diagfiles en formato ncdf

```{r}

files <- list.files("analisis/diagfiles/", pattern = "amsua_n15", full.names = TRUE)

diag_nc <- map(files, function(f) {
  var_names <- GlanceNetCDF(f) %>% 
    .$vars %>% 
    names()
  
  diag <- ReadNetCDF(f, vars = var_names[c(10, 12, 13, 55:79)]) %>% 
    .[, file := f]
}) %>% 
  rbindlist()

diag_nc[Channel_Index %in% c(1:4, 6, 7)] %>% 
  melt(measure.vars = c("Obs_Minus_Forecast_unadjusted", "Obs_Minus_Forecast_adjusted")) %>% 
  ggplot(aes(value)) +
  geom_density(aes(color = variable)) +
  geom_vline(xintercept = 0) +
  facet_wrap(~Channel_Index, scales = "free") +
  labs(x = "Obs - Guess") +
  theme_minimal() +
  theme(legend.position = "bottom")

```


```{r}
diag_nc %>%
  melt(measure.vars = patterns("^BCPred_")) %>%
  ggplot(aes(ConvertLongitude(Longitude), Latitude)) +
  geom_point(aes(color = value)) +
  scale_color_viridis_c() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  facet_wrap(~variable, ncol = 4) +
  theme_minimal()

diag_nc[Channel_Index == 2] %>% 
  
  ggplot(aes(ConvertLongitude(Longitude), Latitude)) +
  geom_point(aes(color = Observation)) +
  scale_color_viridis_c() +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  # facet_wrap(~variable, ncol = 4) +
  theme_minimal()

```

## Comparación entre experimentos

```{r}
perfil_lev_E7 <- fread("analisis/perfiles_ana_E7.csv") %>% 
  .[, date := ymd_hms(date)] 

perfil_lev_E6 <- fread("analisis/perfiles_ana_E6.csv") %>% 
  .[, date := ymd_hms(date)] 

perfil_lev_E4 <- fread("analisis/perfiles_ana_E4.csv") %>% 
  .[, date := ymd_hms(date)] 

perfil_lev_E5 <- fread("analisis/perfiles_ana_E5.csv") %>% 
  .[, date := ymd_hms(date)] 


perfiles <- perfil_lev_E4[perfil_lev_E5, on = c("lev", "date")] %>%
  .[perfil_lev_E6, on = c("lev", "date")] %>% 
  .[perfil_lev_E7, on = c("lev", "date")]%>% 
  setnames(c("T", "QVAPOR", "U", "V", "SPD", 
             "i.T", "i.QVAPOR", "i.U", "i.V", "i.SPD", 
             "i.T.1", "i.QVAPOR.1", "i.U.1", "i.V.1", "i.SPD.1",
             "i.T.2", "i.QVAPOR.2", "i.U.2", "i.V.2", "i.SPD.2"),
           c("T.E4", "Q.E4", "U.E4","V.E4", "SPD.E4",
             "T.E5", "Q.E5", "U.E5","V.E5", "SPD.E5",
             "T.E6", "Q.E6", "U.E6","V.E6", "SPD.E6",
             "T.E7", "Q.E7", "U.E7","V.E7", "SPD.E7")) %>% 
  .[] %>% 
  .[, `:=`(T_E5_E4 = T.E5 - T.E4,
           T_E6_E5 = T.E6 - T.E5,
           T_E7_E4 = T.E7 - T.E4,
           Q_E5_E4 = Q.E5 - Q.E4,
           Q_E6_E5 = Q.E6 - Q.E5,
           Q_E7_E4 = Q.E7 - Q.E4,
           U_E5_E4 = U.E5 - U.E4,
           U_E6_E5 = U.E6 - U.E5,
           U_E7_E4 = U.E7 - U.E4,
           V_E5_E4 = V.E5 - V.E4,
           V_E6_E5 = V.E6 - V.E5,
           V_E7_E4 = V.E7 - V.E4,
           SPD_E5_E4 = SPD.E5 - SPD.E4,
           SPD_E6_E5 = SPD.E6 - SPD.E5,
           SPD_E7_E4 = SPD.E7 - SPD.E4)]

perfiles  %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = T_E7_E4), breaks = seq(-1, 1, 0.2)) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-1, 1, 0.2),
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  labs(title = "Temperature difference (K)",
       subtitle = "RAD - CONV",
       x = "Time",
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```


```{r}
perfiles %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = Q_E7_E4*1000), breaks = seq(-0.0004, 0.0004, 0.0001)*1000) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-0.0004, 0.0004, 0.0001)*1000,
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  labs(title = "Specific humidity difference (g/Kg)",
       subtitle = "RAD - CONV",
       y = "Pressure level",
       x = "Time") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

```{r}
perfiles  %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = U_E7_E4), reaks = seq(-1, 1, 0.2)) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-1, 1, 0.2),
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  labs(title = "U difference (m/s)",
       subtitle = "RAD - CONV",
       x = "Time",
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```


```{r}
perfiles  %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = V_E7_E4), breaks = seq(-1, 2, 0.2)) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-1, 2, 0.2),
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  labs(title = "V difference (m/s)",
       subtitle = "RAD - CONV",
       x = "Time",
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

### Humedad y viento en niveles bajos

```{r warning=FALSE, fig.align="center", fig.height=9, fig.width=14, message=FALSE,}


fcsts <- expand_grid(fcsts = c("20181122000000", "20181122060000"),
                     exp = c("E4", "E7"))

coord <- ReadNetCDF("analisis/q_20181121210000_E3.nc", vars = c(lon = "XLONG")) %>%
  .[, lat := ReadNetCDF("analisis/q_20181121210000_E3.nc", vars = c(lat = "XLAT"))$lat]

q <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0("analisis/u_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(u = "uvmet")) %>% 
    .[, v := ReadNetCDF(paste0("analisis/v_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(v = "uvmet"), out = "vector")] %>% 
    .[, q := ReadNetCDF(paste0("analisis/q_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(q = "QVAPOR"), out = "vector")] %>% 
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist()

q[bottom_top <= 7, .(q = mean(q), u = u[bottom_top == 1], v = v[bottom_top == 1]), 
  by = .(south_north, west_east, date, exp)] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = q*1000)) +
  scale_color_distiller(name = NULL,
                        palette = "BrBG", direction = 1,
                        breaks = seq(0, 0.016, 0.002)*1000,
                        guide = guide_colorstrip(inside = FALSE,
                                                 barwidth = 30,
                                                 barheight = 0.8)) +
  geom_vector(aes(dx = u, dy = v), data = function(x) x[is.cross(south_north, west_east, 5)]) +
  scale_mag() +
  geom_sf(data = map, inherit.aes = FALSE, color = "black", fill = NA, size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  facet_grid(date ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", E7 = "RAD"))) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Low level humidity (g/Kg)",
       x = "Longituted",
       y = "Latitude") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```


```{r}
diff_q_spd <- q[bottom_top <= 7, .(q = mean(q), u = u[bottom_top == 1], v = v[bottom_top == 1]), 
                by = .(south_north, west_east, date, exp)] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>%
  melt(id.vars = c("lon", "lat", "date", "exp"), measure.vars = c("q", "u", "v")) %>% 
  dcast(lon + lat + date + variable ~ exp, value.var = "value") %>% 
  .[, diff_E7_E4 := E7 - E4]

diff_q_spd %>% 
  melt(measure.vars = c("diff_E7_E4"), variable.name = "diff") %>%
  dcast(lon + lat + date + diff ~ variable, value.var = "value") %>% 
  # .[date %in% c("2018-11-22 00:00:00", "2018-11-22 06:00:00")] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = q)) +
  scale_color_divergent(name = NULL,
                        breaks = seq(-0.008, 0.008, 0.002),
                        guide = guide_colorstrip(inside = FALSE,
                                                 barwidth = 0.8,
                                                 barheight = 20)) +
  geom_vector(aes(dx = u, dy = v), data = function(x) x[is.cross(lat, lon, 4)]) +
  scale_mag() +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  facet_grid(date ~ diff, labeller = labeller(diff = c(diff_E6_E5 = "SATWND - AUT",
                                                       diff_E7_E4 = "RAD - CONV"))) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = "Longituted",
       y = "Latitude") +
  theme_minimal(base_size = 16) +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        strip.background = element_blank())
```

### Temperatura y vientos en nivles altos

```{r}
fcsts <- expand_grid(fcsts = c("20181122000000", "20181122060000"),
                     exp = c("E4", "E7"))

coord <- ReadNetCDF("analisis/q_20181121210000_E3.nc", vars = c(lon = "XLONG")) %>%
  .[, lat := ReadNetCDF("analisis/q_20181121210000_E3.nc", vars = c(lat = "XLAT"))$lat]

t <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0("analisis/u_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(u = "uvmet")) %>% 
    .[, v := ReadNetCDF(paste0("analisis/v_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(v = "uvmet"), out = "vector")] %>% 
    .[, t := ReadNetCDF(paste0("analisis/t_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(t = "temp"), out = "vector")] %>% 
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist() %>% 
  .[, date := factor(date)] %>%
  .[coord, on = c("south_north", "west_east")] %>% 
  melt(id.vars = c("lon", "lat", "date", "exp", "bottom_top"),
       measure.vars = c("t", "u", "v")) %>% 
  dcast(lon + lat + date + variable + bottom_top ~ exp, value.var = "value") %>% 
  .[, diff_E7_E4 := E7 - E4]

t[bottom_top %in% seq(1, 28, 3) & variable == "t" & date == unique(date)[2] & abs(diff_E7_E4) < 2] %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = diff_E7_E4)) +
  scale_color_divergent() +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_wrap(~bottom_top, ncol = 5) +
  labs(subtitle = "RAD - CONV",
       x = "Longituted",
       y = "Latitude", 
       color = "Temperature difference (K)") +
  theme_minimal(base_size = 16) +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        legend.position = "bottom",
        strip.background = element_blank())
```

```{r}
fcsts <- expand_grid(fcsts = c("20181122060000"),
                     exp = c("E4", "E7"))

coord <- ReadNetCDF("analisis/q_20181121210000_E3.nc", vars = c(lon = "XLONG")) %>%
  .[, lat := ReadNetCDF("analisis/q_20181121210000_E3.nc", vars = c(lat = "XLAT"))$lat]

wind <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0("analisis/u_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(u = "uvmet")) %>% 
    .[, v := ReadNetCDF(paste0("analisis/v_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(v = "uvmet"), out = "vector")] %>% 
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist() %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  .[, ":="(spd = sqrt(u^2 + v^2),
           dir = circular::as.circular(atan2(u, v), 
                                       type = "directions",
                                       units = "degrees",
                                       rotation = "counter",
                                       zero = pi/2))] 

wind[bottom_top %in% seq(1, 32, 4)] %>% 
  dcast(bottom_top + lon + lat ~ exp, value.var = "spd") %>% 
  .[, diff := E7 - E4] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = diff)) +
  scale_color_divergent() +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_wrap(~bottom_top, ncol = 4) +
  labs(subtitle = "RAD - CONV",
       x = "Longituted",
       y = "Latitude", 
       color = "Wind magnitude difference (m/s)") +
  theme_minimal(base_size = 16) +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        legend.position = "bottom",
        strip.background = element_blank())
```


```{r}
wind[bottom_top %in% c(1, 5, 9, 13, 21, 25, 37, 34)] %>% 
  dcast(bottom_top + lon + lat ~ exp, value.var = "dir") %>% 
  .[, diff := E7 - E4] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = diff)) +
  scale_color_divergent() +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_wrap(~bottom_top, ncol = 4) +
  labs(subtitle = "RAD - CONV",
       x = "Longituted",
       y = "Latitude", 
       color = "Wind direction difference") +
  theme_minimal(base_size = 16) +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        legend.position = "bottom",
        strip.background = element_blank())
```

### Análisis del update

```{r}
dates_amsu <- diag[sensor == "amsua_n15", date] %>% unique(by = "date")

perfil_ana_E7 <- fread("analisis/perfiles_ana_E7.csv") %>% 
  .[, ":="(date = ymd_hms(date),
           run = "ana")] 

perfil_guess_E7 <- fread("analisis/perfiles_guess_E7.csv") %>% 
  .[, ":="(date = ymd_hms(date),
           run = "guess")] 


perfiles <- perfil_ana_E7[perfil_guess_E7, on = c("lev", "date")] %>%
  setnames(c("T", "QVAPOR", "U", "V", "SPD", 
             "i.T", "i.QVAPOR", "i.U", "i.V", "i.SPD"),
           c("T.ana", "Q.ana", "U.ana","V.ana", "SPD.ana",
             "T.guess", "Q.guess", "U.guess","V.guess", "SPD.guess")) %>% 
  .[] %>% 
  .[, `:=`(T_diff = T.ana - T.guess,
           Q_diff = Q.ana - Q.guess,
           U_diff = U.ana - U.guess,
           V_diff = V.ana - V.guess,
           SPD_diff = SPD.ana - SPD.guess)]

perfiles  %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = T_diff), breaks = seq(-0.2, 0.3, 0.05)) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-0.2, 0.3, 0.05),
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  geom_vline(xintercept = dates_amsu) +
  labs(title = "Temperature update (K)",
       x = "Time",
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

```{r}
perfiles %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = Q_diff*1000), 
                    breaks = seq(-0.0001, 0.0001, 0.00002)*1000) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-0.0001, 0.0001, 0.00002)*1000,
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  geom_vline(xintercept = dates_amsu) +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  labs(title = "Specific humidity update (g/Kg)",
       y = "Pressure level",
       x = "Time") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

```{r}
perfiles  %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = U_diff), breaks = seq(-0.4, 0.4, 0.1)) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-0.4, 0.4, 0.1),
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  geom_vline(xintercept = dates_amsu) +
  labs(title = "U update (m/s)",
       x = "Time",
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```


```{r}
perfiles  %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = V_diff), breaks = seq(-0.5, 0.5, 0.2)) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-0.5, 0.5, 0.2),
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  geom_vline(xintercept = dates_amsu) +
  labs(title = "V update (m/s)",
       x = "Time",
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

```{r}
update <- ReadNetCDF("analisis/q_ana_20181123000000_E7.nc", 
                     vars = c(ana = "QVAPOR")) %>% 
  .[, guess := ReadNetCDF("analisis/q_guess_20181123000000_E7.nc", 
                          vars = c(guess = "QVAPOR"), out = "vector")] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, update := ana - guess]


update[bottom_top %in% seq(1, 13, 3)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = update)) +
  scale_color_divergent() +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_wrap(~bottom_top, ncol = 5) +
  labs(x = "Longituted",
       y = "Latitude", 
       color = "Specific humidity update") +
  theme_minimal(base_size = 16) +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        legend.position = "bottom",
        strip.background = element_blank())
```

```{r}
update <- ReadNetCDF("analisis/t_ana_20181123000000_E7.nc", 
                     vars = c(ana = "temp")) %>% 
  .[, guess := ReadNetCDF("analisis/t_guess_20181123000000_E7.nc", 
                          vars = c(guess = "temp"), out = "vector")] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, update := ana - guess]


update[bottom_top %in% seq(1, 13, 3)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = update)) +
  scale_color_divergent() +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_wrap(~bottom_top, ncol = 5) +
  labs(x = "Longituted",
       y = "Latitude", 
       color = "Temperature update") +
  theme_minimal(base_size = 16) +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        legend.position = "bottom",
        strip.background = element_blank())
```
```{r}
update <- ReadNetCDF("analisis/v_ana_20181123000000_E7.nc", 
                     vars = c(ana = "uvmet")) %>% 
  .[, guess := ReadNetCDF("analisis/v_guess_20181123000000_E7.nc", 
                          vars = c(guess = "uvmet"), out = "vector")] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, update := ana - guess]


update[bottom_top %in% seq(1, 39, 3)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = update)) +
  scale_color_divergent() +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_wrap(~bottom_top, ncol = 5) +
  labs(x = "Longituted",
       y = "Latitude", 
       color = "Meridional wind update") +
  theme_minimal(base_size = 16) +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        legend.position = "bottom",
        strip.background = element_blank())
```

```{r}
update <- ReadNetCDF("analisis/v_ana_20181123000000_E7.nc", 
                     vars = c(ana = "uvmet")) %>% 
  .[, guess := ReadNetCDF("analisis/v_guess_20181123000000_E7.nc", 
                          vars = c(guess = "uvmet"), out = "vector")] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, update := ana - guess]


update[bottom_top %in% seq(1, 39, 3)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = update)) +
  scale_color_divergent() +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_wrap(~bottom_top, ncol = 5) +
  labs(x = "Longituted",
       y = "Latitude", 
       color = "Zonal wind update") +
  theme_minimal(base_size = 16) +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        legend.position = "bottom",
        strip.background = element_blank())
```


```{r eval=FALSE, include=FALSE}
diag_E4 <- read_diag_mean("analisis/diagfiles/E4/asim_conv_20181123000000", 
                          variable = c("t", "q", "uv", "p")) %>% 
  .[, ":="(exp = "CONV")]
diag_E7 <- read_diag_mean("analisis/diagfiles/E7/asim_conv_20181123000000",
                          variable = c("t", "q", "uv", "p")) %>% 
  .[, ":="(exp = "RAD")]

diag <- rbind(diag_E4, diag_E7)

diag_E7[var != "t" & type %in% c(181, 287), .N, by = .(exp, type, var)] %>% 
  dcast(type + var ~ exp)

diag_E7[, .N, by = .(lon, lat)] %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_point(aes(color = N)) +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) 

```

